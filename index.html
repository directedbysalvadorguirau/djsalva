<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DJ SALVA #01</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">

  <!-- HLS (para reproducir playlist.m3u8 en Chrome/Firefox) -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    :root{
      --screen-left: 0%;
      --screen-top: 20%;
      --screen-width: 72%;
      --screen-height: 26.9%;
      --btn-bottom: 18.5%;
      --video-scale: 1.2;

      --ui-pad: 14px;
      --panel-w: min(420px, 86vw);
    }

    html, body{
      height:100%;
      margin:0;
      background:#000;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      overflow:hidden;
    }

    .stage{
      height:100vh;
      width:100vw;
      display:grid;
      place-items:center;
      background:#000;
    }

    .frame{
      position:relative;
      height:100vh;
      width:calc(100vh * 9 / 16);
      max-width:100vw;
      max-height:100vh;
      aspect-ratio:9/16;
      overflow:hidden;
    }

    .bg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      pointer-events:none;
      user-select:none;
    }

    .screen{
      position:absolute;
      left:var(--screen-left);
      top:var(--screen-top);
      width:var(--screen-width);
      height:var(--screen-height);
      border-radius:0;
      overflow:hidden;
      background:#fff;
    }

    .screen video{
      width:100%;
      height:100%;
      display:block;
      background:#000;
      object-fit:cover;
      object-position:center;
      transform:scale(var(--video-scale));
      transform-origin:center;
      border-radius:0;
      will-change:transform;
      backface-visibility:hidden;
    }

    .top-actions{
      position:absolute;
      top:var(--ui-pad);
      right:var(--ui-pad);
      display:flex;
      align-items:center;
      gap:10px;
      z-index:50;
    }

    .top-btn,
    .menu-btn{
      width:48px;
      height:48px;
      border:none;
      background:rgba(0,0,0,0.25);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      border-radius:14px;
      display:grid;
      place-items:center;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
    }

    .top-btn:active,
    .menu-btn:active{ transform:scale(0.96); }

    .mini-icon{
      width:24px;
      height:24px;
      fill:#fff;
      filter:drop-shadow(0 8px 18px rgba(0,0,0,0.55));
    }

    .bars{
      width:22px;
      height:18px;
      display:grid;
      align-content:center;
      gap:6px;
    }
    .bars span{
      display:block;
      height:3px;
      background:#fff;
      border-radius:999px;
      filter:drop-shadow(0 8px 18px rgba(0,0,0,0.55));
    }

    .audio-time{
      position:absolute;
      top:var(--ui-pad);
      left:var(--ui-pad);
      color:#fff;
      font-size:48px;
      font-weight:900;
      line-height:1;
      text-shadow:0 8px 18px rgba(0,0,0,0.55);
      user-select:none;
      pointer-events:none;
      z-index:55;
    }

    .play-btn{
      position:absolute;
      left:50%;
      bottom:var(--btn-bottom);
      transform:translateX(-50%);
      width:140px;
      height:140px;
      border:none;
      background:transparent;
      display:grid;
      place-items:center;
      cursor:pointer;
      z-index:20;
      -webkit-tap-highlight-color:transparent;
    }
    .play-btn:active{ transform:translateX(-50%) scale(0.95); }

    .icon{
      width:120px;
      height:120px;
      fill:#fff;
      filter:drop-shadow(0 12px 30px rgba(0,0,0,0.6));
    }

    .overlay{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,0.55);
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease;
      z-index:60;
    }

    .drawer{
      position:absolute;
      top:0;
      right:0;
      height:100%;
      width:var(--panel-w);
      background:rgba(10,10,10,0.92);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transform:translateX(102%);
      transition:transform .22s ease;
      z-index:61;
      display:flex;
      flex-direction:column;
      border-left:1px solid rgba(255,255,255,0.08);
    }

    .drawer header{
      padding:18px 18px 12px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .drawer-title{
      color:#fff;
      font-weight:800;
      letter-spacing:0.2px;
      font-size:18px;
    }

    .close-btn{
      width:40px;
      height:40px;
      border:none;
      background:rgba(255,255,255,0.08);
      border-radius:12px;
      display:grid;
      place-items:center;
      cursor:pointer;
    }
    .close-btn svg{ width:18px; height:18px; fill:#fff; }

    .tracks{
      padding:6px 10px 16px 10px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    .track{
      width:100%;
      display:flex;
      gap:12px;
      align-items:center;
      padding:10px 10px;
      border-radius:14px;
      border:none;
      background:transparent;
      cursor:pointer;
      text-align:left;
    }
    .track:hover{ background:rgba(255,255,255,0.06); }

    .cover{
      width:46px;
      height:46px;
      border-radius:12px;
      background:#111;
      flex:0 0 auto;
      overflow:hidden;
    }
    .cover img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .meta{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
      flex:1 1 auto;
    }

    .name{
      color:#fff;
      font-weight:700;
      font-size:15px;
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .time{
      color:rgba(255,255,255,0.7);
      font-size:13px;
      font-weight:600;
    }

    .open .overlay{
      opacity:1;
      pointer-events:auto;
    }
    .open .drawer{
      transform:translateX(0);
    }

    .sr{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }

    @media (max-width:600px){
      .play-btn{ width:110px; height:110px; }
      .icon{ width:95px; height:95px; }

      .audio-time{
        font-size:36px;
      }

      .top-btn, .menu-btn{
        width:44px;
        height:44px;
      }
    }
  </style>
</head>

<body>
  <div class="stage">
    <div class="frame" id="app">

      <img class="bg" src="laptop-session.png" alt="DJ SALVA #01">

      <div class="screen">
        <!-- IMPORTANTE:
             Quitamos el <source mp4> y cargamos HLS (m3u8) por JS para que vaya fluido -->
        <video id="vid" playsinline webkit-playsinline muted autoplay preload="auto" loop></video>
      </div>

      <audio id="aud" preload="auto">
        <source src="https://djsalva-cdn.b-cdn.net/audio.mp3" type="audio/mpeg">
      </audio>

      <div class="top-actions">
        <button class="top-btn" id="shareBtn" aria-label="Compartir" title="Compartir">
          <svg class="mini-icon" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7a2.5 2.5 0 0 0 0-1.39l7-4.11A2.99 2.99 0 1 0 14 5a3 3 0 0 0 .05.5l-7 4.11a3 3 0 1 0 0 4.78l7.05 4.14c-.03.16-.05.31-.05.47a3 3 0 1 0 3-2.92z"></path>
          </svg>
        </button>

        <button class="menu-btn" id="openLibrary" aria-label="Abrir biblioteca">
          <span class="sr">Abrir biblioteca</span>
          <div class="bars" aria-hidden="true">
            <span></span>
            <span></span>
          </div>
        </button>
      </div>

      <div class="audio-time"><span id="currentTime">0:00</span></div>

      <button id="toggle" class="play-btn" aria-label="Reproducir">
        <span class="sr">Play/Pause</span>

        <svg id="iconPlay" class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M8 5v14l11-7z"></path>
        </svg>

        <svg id="iconPause" class="icon" viewBox="0 0 24 24" aria-hidden="true" style="display:none;">
          <path d="M6 5h4v14H6zm8 0h4v14h-4z"></path>
        </svg>
      </button>

      <div class="overlay" id="overlay"></div>

      <aside class="drawer" id="drawer" aria-label="Biblioteca">
        <header>
          <div class="drawer-title">DJ SALVA #01</div>
          <button class="close-btn" id="closeLibrary" aria-label="Cerrar">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M18.3 5.7 12 12l6.3 6.3-1.4 1.4L10.6 13.4 4.3 19.7 2.9 18.3 9.2 12 2.9 5.7 4.3 4.3l6.3 6.3 6.3-6.3z"></path>
            </svg>
          </button>
        </header>

        <div class="tracks" id="tracks"></div>
      </aside>

    </div>
  </div>

  <script>
    // PWA / SW
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/sw.js").catch(console.log);
      });
    }

    const app = document.getElementById("app");
    const vid = document.getElementById("vid");
    const aud = document.getElementById("aud");

    // ====== HLS SETUP (Bunny Stream) ======
    const HLS_URL = "https://vz-938ede5b-1c2.b-cdn.net/4296b47d-58a1-4bfe-b343-1ae512064f0d/playlist.m3u8";

    let hlsInstance = null;

    function setupHls(){
      // Safari (incluye iOS) soporta HLS nativo
      if (vid.canPlayType("application/vnd.apple.mpegurl")) {
        vid.src = HLS_URL;
        return;
      }

      // Chrome/Firefox/Edge: Hls.js
      if (window.Hls && Hls.isSupported()) {
        hlsInstance = new Hls({
          // Buffers razonables para evitar cortes
          maxBufferLength: 30,
          maxMaxBufferLength: 60,
          lowLatencyMode: false
        });

        hlsInstance.loadSource(HLS_URL);
        hlsInstance.attachMedia(vid);

        // Si quieres ver errores en consola:
        // hlsInstance.on(Hls.Events.ERROR, (evt, data) => console.log("HLS error", data));
        return;
      }

      // Fallback (muy raro)
      console.warn("Este navegador no soporta HLS.");
    }

    setupHls();
    // =====================================

    const btn = document.getElementById("toggle");
    const iconPlay = document.getElementById("iconPlay");
    const iconPause = document.getElementById("iconPause");

    const shareBtn = document.getElementById("shareBtn");
    const currentTimeEl = document.getElementById("currentTime");

    const openLibrary = document.getElementById("openLibrary");
    const closeLibrary = document.getElementById("closeLibrary");
    const overlay = document.getElementById("overlay");
    const tracksEl = document.getElementById("tracks");

    const COVER_SRC = "djsalva-icon.png";
    const VIDEO_RATE = 1.25;
    let videoStarted = false;
    const trackNameEls = [];

    const TRACKS = [
      { t:"FIEL", at:"0:16", unlocked:false },
      { t:"QUE PASARÍA...", at:"2:06", unlocked:false },
      { t:"DIABLITA", at:"3:02", unlocked:false },
      { t:"SI SE DA", at:"4:07", unlocked:false },
      { t:"MEDUSA", at:"6:42", unlocked:false },
      { t:"WYA REMIX RED", at:"7:19", unlocked:false },
      { t:"QUE VAS A HACER HOY ?", at:"7:58", unlocked:false },
      { t:"SOLTERA REMIX", at:"10:05", unlocked:false },
      { t:"MEMORIAS", at:"11:53", unlocked:false },
      { t:"SIN FRENOS", at:"13:20", unlocked:false },
      { t:"TIAGO BZRP", at:"15:00", unlocked:false },
      { t:"MODELITO", at:"17:32", unlocked:false },
      { t:"PUSH UP", at:"18:45", unlocked:false },
      { t:"2PA2", at:"20:05", unlocked:false },
      { t:"GENTLY", at:"21:10", unlocked:false },
      { t:"REAL GANGSTA LOVE", at:"22:17", unlocked:false },
      { t:"DIABÓLICA", at:"23:28", unlocked:false },
      { t:"IGUALES", at:"24:10", unlocked:false },
      { t:"GOTEO", at:"24:50", unlocked:false },
      { t:"SHE DON’T GIVE A FO", at:"26:25", unlocked:false },
      { t:"SE VUELVE LOCA", at:"27:56", unlocked:false },
      { t:"CANDY", at:"30:15", unlocked:false },
      { t:"IA", at:"33:39", unlocked:false },
      { t:"NO PUEDO RESPONDER", at:"35:47", unlocked:false },
      { t:"SE PONE LAS NIKE", at:"36:13", unlocked:false },
      { t:"COCO CHANEL", at:"38:15", unlocked:false },
      { t:"DAME LA VERDE", at:"39:31", unlocked:false },
      { t:"SIN SEÑAL", at:"43:28", unlocked:false },
      { t:"TAROT", at:"45:12", unlocked:false },
      { t:"DIABLA", at:"48:30", unlocked:false },
      { t:"GIRL", at:"50:00", unlocked:false },
      { t:"HASTA QUE DIOS DIGA", at:"52:08", unlocked:false },
      { t:"SERIO CON ESE Q", at:"56:00", unlocked:false },
      { t:"LAS BRATZ REMIX", at:"1:00:18", unlocked:false },
      { t:"BAD GYAL", at:"1:00:39", unlocked:false },
      { t:"PERROS SALVAJES", at:"1:04:40", unlocked:false },
      { t:"SOLTAD A LOS PERROS", at:"1:06:00", unlocked:false },
      { t:"DURO", at:"1:07:14", unlocked:false },
      { t:"SUPERMAN SIN CAPA", at:"1:07:36", unlocked:false },
      { t:"EL TAXI", at:"1:09:40", unlocked:false },
      { t:"LOS APARATOS", at:"1:10:24", unlocked:false },
      { t:"MARIANELA", at:"1:12:32", unlocked:false },
      { t:"LA DESPEDIDA", at:"1:13:51", unlocked:false },
      { t:"COLUMBIA", at:"1:14:18", unlocked:false },
      { t:"ESCLAVA", at:"1:19:54", unlocked:false },
      { t:"STAR", at:"1:23:30", unlocked:false },
      { t:"DÁKITI", at:"1:25:55", unlocked:false },
      { t:"HOLANDA", at:"1:28:52", unlocked:false },
      { t:"LEVELS", at:"1:31:08", unlocked:false },
      { t:"ME PORTO BONITO", at:"1:32:28", unlocked:false },
      { t:"PUNTO G", at:"1:35:21", unlocked:false },
      { t:"LA ZONA", at:"1:38:29", unlocked:false },
      { t:"NO TE QUIEREN CONMIGO", at:"1:40:48", unlocked:false },
      { t:"EL FARSANTE", at:"1:42:54", unlocked:false },
      { t:"CHAMBEA", at:"1:45:35", unlocked:false },
      { t:"NUEVA ERA", at:"1:46:30", unlocked:false },
      { t:"MALBEC", at:"1:47:45", unlocked:false },
      { t:"THE NIGHTS", at:"1:48:15", unlocked:false },
      { t:"MANDANGA STYLE", at:"1:51:16", unlocked:false },
      { t:"HALO", at:"1:53:20", unlocked:false },
      { t:"PRRRUM", at:"1:55:40", unlocked:false },
      { t:"SOLITA", at:"1:57:18", unlocked:false },
    ];

    for (const tr of TRACKS) tr.sec = timeToSeconds(tr.at);

    const SHOW_PLAY = () => {
      iconPlay.style.display = "block";
      iconPause.style.display = "none";
      btn.setAttribute("aria-label", "Reproducir");
    };

    const SHOW_PAUSE = () => {
      iconPlay.style.display = "none";
      iconPause.style.display = "block";
      btn.setAttribute("aria-label", "Pausar");
    };

    vid.loop = true;
    vid.defaultPlaybackRate = VIDEO_RATE;
    vid.playbackRate = VIDEO_RATE;

    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function formatTime(sec){
      if (!Number.isFinite(sec) || sec < 0) return "0:00";
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = Math.floor(sec % 60);

      if (h > 0) {
        return `${h}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
      }
      return `${m}:${String(s).padStart(2,"0")}`;
    }

    function updateSeekUI(time = aud.currentTime || 0){
      currentTimeEl.textContent = formatTime(time);
    }

    function unlockTrack(index){
      const tr = TRACKS[index];
      if (!tr || tr.unlocked) return false;
      tr.unlocked = true;
      const nameEl = trackNameEls[index];
      if (nameEl) nameEl.textContent = tr.t;
      return true;
    }

    function unlockTracksByTime(currentSec){
      for (let i = 0; i < TRACKS.length; i++) {
        if (!TRACKS[i].unlocked && currentSec >= TRACKS[i].sec) {
          unlockTrack(i);
        }
      }
    }

    async function ensureVideoRunning(){
      try{
        vid.playbackRate = VIDEO_RATE;
        if (vid.paused) await vid.play();
        videoStarted = true;
      }catch(e){
        // Autoplay puede fallar en algunos navegadores hasta interacción
      }
    }

    async function playAll(){
      try{
        await Promise.all([
          aud.play(),
          ensureVideoRunning()
        ]);
        SHOW_PAUSE();
      }catch(e){
        if (aud.paused) SHOW_PLAY();
      }
    }

    function pauseAll(){
      aud.pause();
      SHOW_PLAY();
    }

    function seekTo(seconds, autoplay = true){
      const max = Number.isFinite(aud.duration) ? aud.duration : Infinity;
      aud.currentTime = clamp(seconds, 0, max);

      if (autoplay) {
        playAll();
      } else if (aud.paused) {
        SHOW_PLAY();
      }

      unlockTracksByTime(aud.currentTime);
      updateSeekUI(aud.currentTime);
    }

    btn.addEventListener("click", () => {
      if (aud.paused) playAll();
      else pauseAll();
    });

    aud.addEventListener("loadedmetadata", () => updateSeekUI());
    aud.addEventListener("durationchange", () => updateSeekUI());
    aud.addEventListener("timeupdate", () => {
      const now = aud.currentTime || 0;
      updateSeekUI(now);
      unlockTracksByTime(now);
    });
    aud.addEventListener("seeking", () => {
      const now = aud.currentTime || 0;
      updateSeekUI(now);
      unlockTracksByTime(now);
    });

    aud.addEventListener("ended", () => {
      aud.currentTime = 0;
      SHOW_PLAY();
      updateSeekUI(0);
    });

    // Mantener el vídeo rodando (visual)
    vid.addEventListener("pause", () => {
      if (videoStarted) vid.play().catch(() => {});
    });
    vid.addEventListener("stalled", () => {
      if (videoStarted) vid.play().catch(() => {});
    });
    vid.addEventListener("waiting", () => {
      if (videoStarted) vid.play().catch(() => {});
    });

    document.addEventListener("visibilitychange", () => {
      if (!document.hidden) ensureVideoRunning().catch(() => {});
    });

    window.addEventListener("load", () => {
      ensureVideoRunning().catch(() => {});
    });

    shareBtn.addEventListener("click", async () => {
      const url = location.href;
      try{
        if (navigator.share) {
          await navigator.share({ title: "DJ SALVA #01", text: "DJ SALVA #01", url });
        } else {
          await navigator.clipboard.writeText(url);
          if (navigator.vibrate) navigator.vibrate(30);
        }
      }catch(e){ }
    });

    function openDrawer(){ app.classList.add("open"); }
    function closeDrawer(){ app.classList.remove("open"); }

    openLibrary.addEventListener("click", openDrawer);
    closeLibrary.addEventListener("click", closeDrawer);
    overlay.addEventListener("click", closeDrawer);

    function timeToSeconds(str){
      const parts = str.split(":").map(p => p.trim());
      if (parts.length === 2) {
        const m = parseInt(parts[0], 10) || 0;
        const s = parseInt(parts[1], 10) || 0;
        return m * 60 + s;
      }
      if (parts.length === 3) {
        const h = parseInt(parts[0], 10) || 0;
        const m = parseInt(parts[1], 10) || 0;
        const s = parseInt(parts[2], 10) || 0;
        return h * 3600 + m * 60 + s;
      }
      return 0;
    }

    function renderTracks(){
      tracksEl.innerHTML = "";
      trackNameEls.length = 0;

      for (let i = 0; i < TRACKS.length; i++){
        const tr = TRACKS[i];
        const displayName = tr.unlocked ? tr.t : "¿?";
        const trackBtn = document.createElement("button");
        trackBtn.className = "track";
        trackBtn.type = "button";
        trackBtn.innerHTML = `
          <span class="cover"><img src="${COVER_SRC}" alt=""></span>
          <span class="meta">
            <span class="name">${displayName}</span>
            <span class="time">${tr.at}</span>
          </span>
        `;

        const nameEl = trackBtn.querySelector(".name");
        trackNameEls.push(nameEl);

        trackBtn.addEventListener("click", () => {
          unlockTrack(i);
          unlockTracksByTime(tr.sec);
          seekTo(tr.sec, true);
          closeDrawer();
        });

        tracksEl.appendChild(trackBtn);
      }
    }

    renderTracks();
    updateSeekUI(0);
  </script>
</body>
</html>
